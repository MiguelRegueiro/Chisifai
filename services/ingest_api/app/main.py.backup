from fastapi import FastAPI, HTTPException
from pydantic import BaseModel, Field
from sqlalchemy import create_engine, text
from sqlalchemy.orm import sessionmaker
from datetime import datetime
import os

DATABASE_URL = os.getenv("DATABASE_URL", "postgresql+psycopg2://greendelivery:greendelivery@localhost:5432/greendelivery")
engine = create_engine(DATABASE_URL, pool_pre_ping=True)
SessionLocal = sessionmaker(bind=engine)

app = FastAPI(title="GreenDelivery Ingest API", version="0.1.0")

class Telemetry(BaseModel):
    parcel_id: str = Field(..., min_length=1)
    ts: datetime
    temp: float
    g_force: float

@app.get("/health")
def health():
    with engine.connect() as conn:
        conn.execute(text("SELECT 1"))
    return {"ok": True}

@app.post("/ingest/telemetry")
def ingest(t: Telemetry):
    # basic range checks
    if not (-40.0 <= t.temp <= 85.0):
        raise HTTPException(422, "temp out of range")
    if t.g_force < 0.0:
        raise HTTPException(422, "g_force must be >= 0")

    with engine.begin() as conn:
        conn.execute(
            text("INSERT INTO telemetry (parcel_id, ts, temp, g_force) VALUES (:parcel_id, :ts, :temp, :g_force)"),
            {"parcel_id": t.parcel_id, "ts": t.ts, "temp": t.temp, "g_force": t.g_force}
        )
    return {"ok": True}
